\documentclass[10pt, compress]{beamer}
\XeTeXlinebreaklocale "ja"
\XeTeXlinebreakskip=0em plus 0.1em minus 0.01em

\usetheme[usetitleprogressbar]{m}

\usepackage{booktabs}
\usepackage{minted}
\usepackage{fontawesome}
\usepackage{gnuplot-lua-tikz}
\usepackage{tcolorbox}

%%% user macro
\definecolor{links}{HTML}{DB4D6D} % NAKABENI
\hypersetup{colorlinks,linkcolor=,urlcolor=links}

%\tcbset{
%	width=.9\linewidth
%}

\newcommand{\ehref}[2]{\href{#1}{#2 \hspace{-.2em}{\scriptsize\faExternalLink}}}
%\newcommand{\eurl}[1]{\url{#1{\scriptsize \hspace{-.2em}\faExternalLink}}}
%%%

\usepgfplotslibrary{dateplot}

\usemintedstyle{trac}

\title{マルチポート10G NICの試作}
\subtitle{}
\date[\today]{}
%\author{Name (\ehref{http://twitter.com/twitter}{\faTwitter  twitter})}
\author{Yohei Kuga@KEIO Univ}
\institute{高速PCルータ研究会 2015/5}

\begin{document}

\maketitle

%% -------------------------------------------------- %%

\begin{frame}[fragile,t]{今日の話}
\begin{enumerate}
\item PCIe NICの基礎体力測定
\item FPGA+SystemVerilogで合成可能なパケット処理を考える
\item マルチポート10G NICの設計
	\begin{itemize}
	\item Motivation
	\item その他のFPGA NIC実装
	\item NIC Offload機能の整理
	\item 検討中のNICアーキテクチャ
	\end{itemize}
\end{enumerate}
\end{frame}

%% -------------------------------------------------- %%

\begin{frame}[fragile,t]{その他のNIC実装}
\begin{itemize}
	\item VC709 Connectivity TRD
	\begin{itemize}
		\item 合成時間: 約2h
	\end{itemize}
	\item NetFPGA (NAAS)
\end{itemize}
\end{frame}

%% -------------------------------------------------- %%

\begin{frame}[fragile,t]{今日の話}

ネットワークを高機能化するためにNICを自由に拡張したい
\vspace{.5em}

最近のDC+SW界隈 (Kernel bypass/Unikernels) に比べて，ネットワークHWはまだまだユーザ拡張性が低い
\vspace{-.5em}
\begin{itemize}
\item 現在のOffload機能はL2\~{}L4パケットヘッダ操作が主流
    \begin{itemize}
        \item Capsulation, CSUM, TCP など
    \end{itemize}
\item Programmable NICの検討は始まっている
\end{itemize}
\vspace{.5em}

"NICがProgrammableであること"が最初の一歩
\vspace{-.5em}
\begin{itemize}
\item ヘッダやFIB操作はProgrammable NICやNPUで実現可能
\item ペイロード操作/Interrupt/PCIe/遅延制御などを直接触りたいならFPGA NICが有力
\end{itemize}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}[fragile,t]
  \frametitle{Systemverilogによるパケット処理 [2/3]}

\begin{figure}
\begin{tcolorbox}[title=ethernet\_pkg.sv]
\begin{minted}[fontsize=\small]{verilog}
/* MAC adderss */
typedef bit [ETH_ALEN-1:0][7:0] macaddr_t;

/* ethernet header */
typedef struct packed {
    macaddr_t h_dest;
    macaddr_t h_source;
    bit [15:0] h_proto;
} ethhdr;
\end{minted}
\end{tcolorbox}
\end{figure}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}[fragile,t]
  \frametitle{Systemverilogによるパケット処理 [1/3]}

\begin{figure}
\begin{tcolorbox}[title=user\_app.sv]
\begin{minted}[fontsize=\small]{verilog}
union packed {
    bit [5:0][63:0] raw;      // XGMII (64bit)
    struct packed {
        ethhdr eth;
        iphdr ip;
        udphdr udp;
        bit [47:0] padding;
    } hdr;
} tx_pkt, rx_pkt;
\end{minted}
\end{tcolorbox}
\end{figure}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}[fragile,t]
  \frametitle{Systemverilogによるパケット処理 [3/3]}

\vspace{-1em}

\begin{figure}
\begin{tcolorbox}[title=TX]
\begin{minted}[fontsize=\small]{verilog}
// User register to XGMII_TX
xgmii.data = endian_conv64(tx_pkt.raw[5]);
\end{minted}
\end{tcolorbox}
%
\begin{tcolorbox}[title=RX]
\begin{minted}[fontsize=\small]{verilog}
// XGMII_RX to User register
rx_pkt.raw[5] <= endian_conv64(xgmii_rx.data);
...
// packet filtering
if (rx_pkt.hdr.eth.h_proto == ETH_P_IP &&
    rx_pkt.hdr.ip.protocol == IP4_PROTO_UDP &&
    rx_pkt.hdr.udp.dest    == 16'd9) begin
\end{minted}
\end{tcolorbox}
\end{figure}

\vspace{-.5em}
Raw socket ぽい?
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{マスク(物理)}

\begin{figure}
\includegraphics[width=.9\textwidth]{pic/x1.png} \\
\includegraphics[width=.9\textwidth]{pic/x4.png}

\begin{scriptsize}
\begin{tcolorbox}[width=.9\linewidth]
\$ sudo lspci -vv\\
01:00.0 Ethernet controller: Intel Corporation 82599ES\\
LnkCap: Port \#0, \textbf{Speed 5GT/s, Width x8}, ... \\
LnkSta: \textbf{Speed 5GT/s, Width x1}, ...
\end{tcolorbox}
\end{scriptsize}
\vspace{-.5em}
\small{上: x1マスク, 中: x4マスク, 下: x1時のLink status}
\end{figure}


\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{Max. TX Throughput (Intel x520)}
	\begin{figure}
		\resizebox{.7\textwidth}{!}{\input{fig/pcie-lane-bps}}
	\end{figure}
	{\footnotesize Theoretical Max. Throughput (PCIe gen2) * 0.8 (8b/10b overhead): \\
	x1: 4Gbps, x2: 8Gbps, x4: 16Gbps, x8: 32Gbps}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}{\% of Theoretical Max. TX Throughput (Intel x520)}
	\begin{figure}
		\resizebox{.7\textwidth}{!}{\input{fig/pcie-lane-ratio}}
	\end{figure}
	{\footnotesize Theoretical Max. Throughput (PCIe gen2) * 0.8 (8b/10b overhead): \\
	x1: 4Gbps, x2: 8Gbps, x4: 16Gbps, x8: 32Gbps}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}[fragile,t]{NICのPCIe基礎体力測定 考察}
	\vspace{-2em}
	\begin{figure}
		\resizebox{.8\textwidth}{!}{\input{fig/pcie-lane-ratio2}}
	\end{figure}
	\vspace{-1.5em}

	\begin{itemize}
	\item PCIe利用可能帯域を計測することでNIC回路の性能を推測
	\begin{itemize}
		\item 送信のみの場合，PCIeの約81\%の帯域が利用可能
		\item 送受信時，PCIeの約73\%の帯域が利用可能
		\item 送受信時，1514B-60Bで約20\%利用可能帯域が減少
		\item (PCIeはFull duplexにも関わらず) 60B送受信-送信のみ で，\\
		      PCIe利用可能帯域が約18\%減少
	\end{itemize}

	\item 検討内容
	\begin{enumerate}
		\item パケットサイズとPCIe利用可能帯域の関係
		\item Full duplexとPCIe利用可能帯域の関係
	\end{enumerate}
	\end{itemize}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Conclusion}

\begin{frame}{Summary}

  Get the source of this theme and the demo presentation from

  \begin{center}\url{github.com/matze/mtheme}\end{center}

  The theme \emph{itself} is licensed under a
  \ehref{http://creativecommons.org/licenses/by-sa/4.0/}{Creative Commons
  Attribution-ShareAlike 4.0 International License}.

\end{frame}

\plain{Questions? \faSmile}

\end{document}
